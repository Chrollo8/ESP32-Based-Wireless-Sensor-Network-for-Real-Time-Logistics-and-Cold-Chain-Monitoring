<!DOCTYPE HTML><html>
<head>
  <title>ThermaTrack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f0f0;
      min-width: 310px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2.5rem;
    }
    h3 {
      color: #007bff;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }
    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }
    .status.connected {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.disconnected {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .gps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .accel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .data-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }
    .data-card.accel-x {
      border-left-color: #dc3545;
    }
    .data-card.accel-y {
      border-left-color: #28a745;
    }
    .data-card.accel-z {
      border-left-color: #ffc107;
    }
    .data-card h3 {
      margin-top: 0;
      color: #007bff;
      border: none;
      padding-bottom: 0;
    }
    .data-card.accel-x h3 {
      color: #dc3545;
    }
    .data-card.accel-y h3 {
      color: #28a745;
    }
    .data-card.accel-z h3 {
      color: #ffc107;
      color: #856404;
    }
    .data-value {
      font-size: 1.2em;
      font-weight: bold;
      color: #333;
    }
    .map-container {
      margin: 20px 0;
      height: 400px;
      border: 2px solid #ddd;
      border-radius: 8px;
    }
    .chart-container {
        margin-bottom: 20px;
    }
    /* Temperature status monitor styles */
    .temp-status {
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      max-width: 1200px;
      margin: 0 auto 20px auto;
      transition: background-color 0.5s ease, color 0.5s ease;
    }
    .temp-status h3 {
      margin-top: 0;
      font-size: 1.5em;
      border: none;
      padding-bottom: 0;
    }
    .temp-status p {
      margin-bottom: 0;
      font-size: 1.2em;
    }
    .temp-status.normal {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .temp-status.breach {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .temp-status.disconnected {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    /* Sensor status indicator */
    .sensor-status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8em;
      font-weight: bold;
      margin-left: 10px;
    }
    .sensor-status.online {
      background-color: #d4edda;
      color: #155724;
    }
    .sensor-status.offline {
      background-color: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ThermaTrack</h2>
  </div>

  <!-- Temperature Status Monitoring Section -->
  <div id="tempStatusContainer" class="temp-status disconnected">
      <h3>Status Unknown</h3>
      <p>Connecting to monitoring device...</p>
  </div>

  <div class="container">
    <h3>Motion & Orientation Monitoring <span id="mpuStatus" class="sensor-status offline">MPU6050 Offline</span></h3>
    <div class="accel-grid">
      <div class="data-card accel-x">
        <h3>X-Axis</h3>
        <div class="data-value" id="accel-x">-- m/s²</div>
      </div>
      <div class="data-card accel-y">
        <h3>Y-Axis</h3>
        <div class="data-value" id="accel-y">-- m/s²</div>
      </div>
      <div class="data-card accel-z">
        <h3>Z-Axis</h3>
        <div class="data-value" id="accel-z">-- m/s²</div>
      </div>
    </div>
    <div id="chart-acceleration" class="chart-container"></div>
  </div>

  <div class="container">
    <h3>GPS Tracking</h3>
    <div id="gpsStatus" class="status disconnected">GPS Signal: Searching...</div>
    <div class="gps-grid">
      <div class="data-card">
        <h3>Location</h3>
        <div class="data-value">Lat: <span id="latitude">--</span><br>Lng: <span id="longitude">--</span></div>
      </div>
      <div class="data-card">
        <h3>Satellites</h3>
        <div class="data-value" id="satellites">--</div>
      </div>
      <div class="data-card">
        <h3>Altitude</h3>
        <div class="data-value" id="altitude">--</div>
      </div>
      <div class="data-card">
        <h3>Last Update</h3>
        <div class="data-value" id="timestamp">--</div>
      </div>
    </div>
    <div class="map-container">
      <iframe id="mapFrame" width="100%" height="100%" style="border:0" loading="lazy" allowfullscreen 
              src="about:blank"></iframe>
    </div>
  </div>

  <div class="container">
    <h3>Vaccine Carrier Environment</h3>
    <div id="chart-temperature" class="chart-container"></div>
    <div id="chart-humidity" class="chart-container"></div>
    <div id="chart-pressure" class="chart-container"></div>
  </div>

<script>
// --- Highcharts Setup ---
var chartT = new Highcharts.Chart({
  chart:{ renderTo : 'chart-temperature' },
  title: { text: 'Temperature' },
  series: [{ showInLegend: false, data: [] }],
  plotOptions: {
    line: { animation: false, dataLabels: { enabled: true } },
    series: { color: '#059e8a' }
  },
  xAxis: { type: 'datetime', dateTimeLabelFormats: { second: '%H:%M:%S' } },
  yAxis: { title: { text: 'Temperature (°C)' } },
  credits: { enabled: false }
});

var chartH = new Highcharts.Chart({
  chart:{ renderTo:'chart-humidity' },
  title: { text: 'Humidity' },
  series: [{ showInLegend: false, data: [] }],
  plotOptions: { line: { animation: false, dataLabels: { enabled: true } } },
  xAxis: { type: 'datetime', dateTimeLabelFormats: { second: '%H:%M:%S' } },
  yAxis: { title: { text: 'Humidity (%)' } },
  credits: { enabled: false }
});

var chartP = new Highcharts.Chart({
  chart:{ renderTo:'chart-pressure' },
  title: { text: 'Pressure' },
  series: [{ showInLegend: false, data: [] }],
  plotOptions: {
    line: { animation: false, dataLabels: { enabled: true } },
    series: { color: '#18009c' }
  },
  xAxis: { type: 'datetime', dateTimeLabelFormats: { second: '%H:%M:%S' } },
  yAxis: { title: { text: 'Pressure (hPa)' } },
  credits: { enabled: false }
});

// NEW: Acceleration Chart with 3 series for X, Y, Z axes
var chartA = new Highcharts.Chart({
  chart:{ renderTo:'chart-acceleration' },
  title: { text: 'Acceleration (X, Y, Z Axes)' },
  series: [
    { name: 'X-Axis', data: [], color: '#dc3545' },
    { name: 'Y-Axis', data: [], color: '#28a745' },
    { name: 'Z-Axis', data: [], color: '#ffc107' }
  ],
  plotOptions: { 
    line: { animation: false, dataLabels: { enabled: false } }
  },
  xAxis: { type: 'datetime', dateTimeLabelFormats: { second: '%H:%M:%S' } },
  yAxis: { title: { text: 'Acceleration (m/s²)' } },
  credits: { enabled: false },
  legend: { enabled: true }
});

// --- Data Fetching Functions ---
function addPointToChart(chart, value) {
    var x = (new Date()).getTime();
    var y = parseFloat(value);
    if (!isNaN(y)) {
        if (chart.series[0].data.length > 40) {
            chart.series[0].addPoint([x, y], true, true, true);
        } else {
            chart.series[0].addPoint([x, y], true, false, true);
        }
    }
}

function addAccelerationPoint(chart, x, y, z) {
    var timestamp = (new Date()).getTime();
    var xVal = parseFloat(x);
    var yVal = parseFloat(y);
    var zVal = parseFloat(z);
    
    if (!isNaN(xVal) && !isNaN(yVal) && !isNaN(zVal)) {
        // X-Axis series (index 0)
        if (chart.series[0].data.length > 40) {
            chart.series[0].addPoint([timestamp, xVal], false, true, true);
        } else {
            chart.series[0].addPoint([timestamp, xVal], false, false, true);
        }
        
        // Y-Axis series (index 1)
        if (chart.series[1].data.length > 40) {
            chart.series[1].addPoint([timestamp, yVal], false, true, true);
        } else {
            chart.series[1].addPoint([timestamp, yVal], false, false, true);
        }
        
        // Z-Axis series (index 2)
        if (chart.series[2].data.length > 40) {
            chart.series[2].addPoint([timestamp, zVal], true, true, true);
        } else {
            chart.series[2].addPoint([timestamp, zVal], true, false, true);
        }
    }
}

// Environmental sensors data fetching
setInterval(function () {
  fetch(window.location.origin + '/temperature').then(response => response.text()).then(data => addPointToChart(chartT, data));
  fetch(window.location.origin + '/humidity').then(response => response.text()).then(data => addPointToChart(chartH, data));
  fetch(window.location.origin + '/pressure').then(response => response.text()).then(data => addPointToChart(chartP, data));
}, 5000);

// NEW: Acceleration data fetching
function updateAccelerationData() {
  fetch(window.location.origin + '/acceleration')
    .then(response => response.json())
    .then(data => {
      const mpuStatus = document.getElementById('mpuStatus');
      if (data.initialized) {
        mpuStatus.textContent = 'MPU6050 Online';
        mpuStatus.className = 'sensor-status online';
        
        // Update individual axis displays
        document.getElementById('accel-x').textContent = data.x.toFixed(3) + ' m/s²';
        document.getElementById('accel-y').textContent = data.y.toFixed(3) + ' m/s²';
        document.getElementById('accel-z').textContent = data.z.toFixed(3) + ' m/s²';
        
        // Add points to chart
        addAccelerationPoint(chartA, data.x, data.y, data.z);
      } else {
        mpuStatus.textContent = 'MPU6050 Offline';
        mpuStatus.className = 'sensor-status offline';
        document.getElementById('accel-x').textContent = '-- m/s²';
        document.getElementById('accel-y').textContent = '-- m/s²';
        document.getElementById('accel-z').textContent = '-- m/s²';
      }
    })
    .catch(error => {
        console.error('Error fetching acceleration data:', error);
        const mpuStatus = document.getElementById('mpuStatus');
        mpuStatus.textContent = 'MPU6050 Error';
        mpuStatus.className = 'sensor-status offline';
    });
}

// Temperature breach monitoring
function checkBreachStatus() {
  fetch(window.location.origin + '/breach-status')
    .then(response => response.json())
    .then(data => {
      const statusContainer = document.getElementById('tempStatusContainer');
      if (data.temp_breach || data.humidity_breach) {
        statusContainer.className = 'temp-status breach';
        let breachMessage = 'EMERGENCY! ';
        if (data.temp_breach) {
          breachMessage += `Temperature: ${data.temperature.toFixed(2)}°C (Range: ${data.min_temp.toFixed(1)}°C - ${data.max_temp.toFixed(1)}°C)`;
        }
        if (data.humidity_breach) {
          if (data.temp_breach) breachMessage += ' | ';
          breachMessage += `Humidity: ${data.humidity.toFixed(2)}% (Range: ${data.min_humidity.toFixed(1)}% - ${data.max_humidity.toFixed(1)}%)`;
        }
        statusContainer.innerHTML = `<h3>BREACH DETECTED!</h3><p>${breachMessage}</p>`;
      } else {
        statusContainer.className = 'temp-status normal';
        statusContainer.innerHTML = `
          <h3>Everything is Fine</h3>
          <p>Temperature: ${data.temperature.toFixed(2)}°C | Humidity: ${data.humidity.toFixed(2)}% | All parameters within safe range.</p>
        `;
      }
    })
    .catch(error => {
        console.error('Error fetching breach status:', error);
        const statusContainer = document.getElementById('tempStatusContainer');
        statusContainer.className = 'temp-status disconnected';
        statusContainer.innerHTML = `<h3>Status Unknown</h3><p>Could not connect to the monitoring device.</p>`;
    });
}

function updateGPSData() {
  fetch(window.location.origin + '/gps').then(response => response.json()).then(data => {
    if (data.valid) {
      document.getElementById('gpsStatus').className = 'status connected';
      document.getElementById('gpsStatus').textContent = 'GPS Signal: Active';
      document.getElementById('latitude').textContent = data.latitude.toFixed(6);
      document.getElementById('longitude').textContent = data.longitude.toFixed(6);
      document.getElementById('satellites').textContent = data.satellites;
      document.getElementById('altitude').textContent = data.altitude.toFixed(2) + ' m';
      document.getElementById('timestamp').textContent = data.timestamp;
      var mapUrl = 'https://maps.google.com/maps?q=' + data.latitude + ',' + data.longitude + '&z=15&output=embed';
      var mapFrame = document.getElementById('mapFrame');
      if (mapFrame.src !== mapUrl) {
        mapFrame.src = mapUrl;
      }
    } else {
      document.getElementById('gpsStatus').className = 'status disconnected';
      document.getElementById('gpsStatus').textContent = 'GPS Signal: Searching...';
    }
  }).catch(error => {
    console.error('Error fetching GPS data:', error);
    document.getElementById('gpsStatus').className = 'status disconnected';
    document.getElementById('gpsStatus').textContent = 'GPS Signal: Disconnected';
  });
}

// Set intervals for all data updates
setInterval(updateGPSData, 5000);
setInterval(checkBreachStatus, 5000);
setInterval(updateAccelerationData, 2000); // Update acceleration data more frequently

// Initial calls on page load
window.onload = function() {
    updateGPSData();
    checkBreachStatus();
    updateAccelerationData();
};

</script>
</body>
</html>